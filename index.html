<html>
<meta charset="UTF-8"/>
<script src="//cdnjs.cloudflare.com/ajax/libs/dropbox.js/0.10.2/dropbox.min.js"></script>
<script type="text/javascript" src="/elm-runtime.js"></script>
<script type="text/javascript" src="build/Main.js"></script>
<style>
.selected {
  border: 1px solid blue;
  background: #99f;
}
.cursor {
  width: 0px;
  overflow: visible;
  position: relative;
  left: -0.3em;
  top: 0.7em;
  display: inline-block;
  color: red;
}
</style>
<body></body>
<script>
var runningElmModule = Elm.fullscreen(Elm.Main, {
  downsIn: 0,
  pressesIn: "",
  dropboxIn: "",
  metaIn: 0
});

var specialKeys = {
  '8': 'backspace',
  '37': 'left',
  '38': 'up',
  '39': 'right',
  '40': 'down'
};

var modKeys = {
  '91': 'meta'
};

var downMods = {};

document.onkeydown = function(e) {
  var mod;
  if (mod = modKeys[e.keyCode.toString()]) {
    downMods[mod] = true;
    e.preventDefault();
  } else if (specialKeys[e.keyCode.toString()]) {
    runningElmModule.ports.downsIn.send(e.keyCode);
    e.preventDefault();
  } else {
    if (downMods.meta) {
      runningElmModule.ports.metaIn.send(e.keyCode);
      e.preventDefault();
    }
  }
}

document.onkeypress = function(e) {
  var evt = evt || window.event;
  var charCode = evt.which || evt.keyCode;
  var charTyped = String.fromCharCode(charCode);
  runningElmModule.ports.pressesIn.send(charTyped);
  e.preventDefault();
}

document.onkeyup = function(e) {
  var mod;
  if (mod = modKeys[e.keyCode.toString()]) {
    downMods[mod] = false;
    e.preventDefault();
  }
}

// ---- DROPBOX

var client = new Dropbox.Client({ key: "mjplyqeks6z3js8" });

client.authenticate(function(error, client) {
  if (error) {
    return alert(error);
  }
  console.log("Dropbox is authorized");
  client.readFile("outlin.json", function(error, data) {
    if (error) {
      return alert(error);
    }
    console.log("Read outlin.json from Dropbox");
    runningElmModule.ports.dropboxIn.send(data);
  });

  runningElmModule.ports.dropboxOut.subscribe(function(json) {
    console.log("Got " + json.slice(0, 100));
    client.writeFile("outlin.json", json, function(error, stat) {
      if (error) {
        return alert(error);
      }
      console.log("outlin.json saved as revision " + stat.versionTag);
    });
  });
});

</script>
</html>